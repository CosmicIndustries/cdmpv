# mpv.conf — cleaned & optimized for Vulkan + shader upscaling workflow
# Preserves original behaviour while removing duplicates and consolidating network/audio/video settings.

# -------------------------
# Core / general
# -------------------------
hwdec=auto-safe                   # safer auto hwdec selection for Vulkan setups
no-resume-playback
input-ipc-server=/tmp/mpvsocket
hr-seek-framedrop=no
msg-color=yes
msg-module=yes
keepaspect=yes

framedrop=decoder+vo
fullscreen
border=no

# Output / GPU
vo=gpu
profile=gpu-hq
gpu-api=vulkan
gpu-context=x11vk
spirv-compiler=auto

# Vulkan / swap / pipeline
fbo-format=rgba16hf
swapchain-depth=1
vulkan-async-compute=yes
vulkan-async-transfer=yes
vulkan-queue-count=1
vulkan-swap-mode=immediate

# Keep-open so processes using mpv as a pipeline don't terminate unexpectedly
keep-open=yes

# -------------------------
# Subtitles
# -------------------------
sub-font=LinBiolinumOB
sub-font-size=52
sub-ass-vsfilter-blur-compat=yes
sub-ass-scale-with-window=no
sub-auto=fuzzy
sub-file-paths-append=ass
sub-file-paths-append=srt
sub-file-paths-append=sub
sub-file-paths-append=subs
sub-file-paths-append=subtitles
embeddedfonts=yes
blend-subtitles=no

# -------------------------
# Audio
# -------------------------
af=scaletempo=stride=22:overlap=.55:search=12
ad-lavc-downmix=yes
ao=pulse
audio-file-auto=fuzzy
stream-lavf-o="reconnect=1,reconnect_at_eof=1,reconnect_streamed=1,overrun_nonfatal=1"

# -------------------------
# Scaling / upscaling core settings
# -------------------------
cscale=lanczos
cscale-antiring=0.7
scale=spline36
scale-antiring=1.0
dscale=lanczos
dscale-antiring=0.7
correct-downscaling=yes
linear-downscaling=no
sigmoid-upscaling=yes
scale-antiring=1.0

# -------------------------
# Screenshots / OSD
# -------------------------
screenshot-format=png
screenshot-directory=/tmp/
screenshot-high-bit-depth=yes
screenshot-png-compression=0
screenshot-tag-colorspace=yes
osd-duration=450

# -------------------------
# Demuxer / rawvideo / low-latency profiles
# -------------------------
# qrawvideo profile used for rawvideo cases (cdmpv pipe -> mpv)
[qrawvideo]
profile=low-latency
cache=no
demuxer-readahead-secs=0
no-correct-pts
no-pause
demuxer-lavf-o-add="fflags=+nobuffer+fastseek+flush_packets"
demuxer-termination-timeout=5
vd-lavc-threads=1
vd-lavc-threads=1
no-pause

# -------------------------
# Protocol / network: consolidated settings
# -------------------------
[protocol-network]
network-timeout=2
hls-bitrate=max
cache=yes
demuxer-max-bytes=2000MiB
demuxer-readahead-secs=300

[protocol.http]
profile=protocol-network

[protocol.https]
profile=protocol-network

# -------------------------
# Rawvideo handling
# -------------------------
[rawvideo]
profile-cond=p["video-codec"] == "rawvideo"
profile=qrawvideo
profile=notime
stop-screensaver=no

# -------------------------
# Auto-profiles for different upscaling scenarios
# Each profile clears shaders first, then applies the intended chain.
# -------------------------

[justrepairNoAlpha]
profile-desc=justrepair
profile-cond=(get("osd-width") and get("video-params/dw") and get("osd-width") / get("video-params/dw") <= 1.02 and not (get("video-params/alpha") and (get("video-params/alpha") == "straight" or get("video-params/alpha") == "premul")))
dscale=lanczos
dscale-antiring=0.7
vf=""
glsl-shaders-clr
glsl-shaders="~~/shaders/igv/KrigBilateral.glsl:~~/shaders/Anime4K_Restore_CNN_Light_Soft_M-YYY-percent70.glsl:~~/shaders/igv/SSimSuperRes.glsl"

[justrepairWITHAlpha]
profile-desc=justrepair
profile-cond=(get("osd-width") and get("video-params/dw") and get("osd-width") / get("video-params/dw") <= 1.02 and (get("video-params/alpha") and (get("video-params/alpha") == "straight" or get("video-params/alpha") == "premul")))
dscale=lanczos
dscale-antiring=0.7
vf="format=fmt=gbrp:colorlevels=limited:colormatrix=auto"
glsl-shaders-clr
glsl-shaders="~~/shaders/igv/KrigBilateral.glsl:~~/shaders/Anime4K_Restore_CNN_Light_Soft_M-YYY-percent70.glsl:~~/shaders/igv/SSimSuperRes.glsl"

[scale2xNoAlphaFAST]
profile-desc=scale2x
profile-cond=(get("osd-width") and get("video-params/dw") and (get("video-params/dw") > 1579 and get("osd-width") / get("video-params/dw") <= 1.23) and get("osd-width") / get("video-params/dw") > 1.02 and get("osd-width") / get("video-params/dw") <= 2.02 and not (get("video-params/alpha") and (get("video-params/alpha") == "straight" or get("video-params/alpha") == "premul")))
dscale=lanczos
dscale-antiring=0.7
vf=""
glsl-shaders-clr
glsl-shaders="~~/shaders/igv/KrigBilateral.glsl:~~/shaders/Anime4K_Clamp_Highlights.glsl:~~/shaders/chroma-save-MAIN.glsl:~~/shaders/luma-save-MAIN.glsl:~~/shaders/Anime4K_Upscale_CNN_x2_ULF-fastKrigBilateral_for_V_channel.glsl:~~/shaders/igv/SSimSuperRes.glsl"

[scale2xNoAlphaSLOW]
profile-desc=scale2x
profile-cond=(get("osd-width") and get("video-params/dw") and not (get("video-params/dw") > 1579 and get("osd-width") / get("video-params/dw") <= 1.23) and get("osd-width") / get("video-params/dw") > 1.02 and get("osd-width") / get("video-params/dw") <= 2.02 and not (get("video-params/alpha") and (get("video-params/alpha") == "straight" or get("video-params/alpha") == "premul")))
dscale=lanczos
dscale-antiring=0.7
vf=""
glsl-shaders-clr
glsl-shaders="~~/shaders/igv/KrigBilateral.glsl:~~/shaders/Anime4K_Clamp_Highlights.glsl:~~/shaders/chroma-save-MAIN.glsl:~~/shaders/luma-save-MAIN.glsl:~~/shaders/Anime4K_Upscale_CNN_x2_ULF-fastKrigBilateral_for_V_channel.glsl:~~/shaders/Anime4K_Restore_CNN_Light_S-YYY-half.glsl:~~/shaders/igv/SSimSuperRes.glsl"

[scale3x]
profile-desc=scale3x
profile-cond=(get("osd-width") and get("video-params/dw") and get("osd-width") / get("video-params/dw") > 2.02 and get("osd-width") / get("video-params/dw") <= 3.02)
dscale=catmull_rom
dscale-antiring=0.7
vf=format=fmt=yuv444p10:colorlevels=limited:colormatrix=auto
glsl-shaders-clr
glsl-shaders="~~/shaders/igv/KrigBilateral.glsl:~~/shaders/Anime4K_Clamp_Highlights-LUMA-first-init.glsl:~~/shaders/Anime4K_Upscale_GAN_x3_VL-LUMA.glsl:~~/shaders/Anime4K_Clamp_Highlights-LUMA-apply.glsl:~~/shaders/Anime4K_Restore_CNN_Moderate_VL-YYY.glsl:~~/shaders/igv/SSimSuperRes.glsl"

[scale4x]
profile-desc=scale4x
profile-cond=(get("osd-width") and get("video-params/dw") and get("video-params/dw") <= 1024 and get("osd-width") / get("video-params/dw") > 3.02)
dscale=catmull_rom
dscale-antiring=0.7
vf=format=fmt=yuv444p10:colorlevels=limited:colormatrix=auto
glsl-shaders-clr
glsl-shaders="~~/shaders/igv/KrigBilateral.glsl:~~/shaders/Anime4K_Clamp_Highlights-LUMA-first-init.glsl:~~/shaders/Anime4K_Upscale_GAN_x3_VL-LUMA.glsl:~~/shaders/Anime4K_Clamp_Highlights-LUMA-apply.glsl:~~/shaders/Anime4K_Restore_CNN_Moderate_VL-YYY.glsl:~~/shaders/Anime4K_Upscale_CNN_x2_L.glsl:~~/shaders/igv/SSimSuperRes.glsl"

# -------------------------
# HDR -> SDR mapping (preserved)
# -------------------------
[HDR2SDR]
profile-desc=HDR映射
profile-cond=p["video-params/primaries"]=="bt.2020"
profile-restore=copy
vf=""

# -------------------------
# OpenGL fallback profile (kept for systems that prefer OpenGL)
# -------------------------
[opengl]
gpu-api=opengl
gpu-context=x11vk
fbo-format=rgba16f

# -------------------------
# Misc safe defaults for rawvideo / screenshots
# -------------------------
[notime]
osd-msg3="ds=${dscale}\nup=${scale}\nw${video-params/dw}→w${osd-width}"

[extension.webp]
profile=notime

[extension.png]
profile=extension.webp
profile=notime

# End of config
